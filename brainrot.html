<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
            display: flex;
        }

        .left-videos, .right-videos {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
            min-width: 0;
        }

        .video-row {
            display: flex;
            gap: 2px;
            min-height: 0;
            flex: 1;
        }

        .video-container {
            position: relative;
            overflow: hidden;
            background: #000;
            flex: 1;
            min-width: 0;
            min-height: 0;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .timer-section {
            width: 350px;
            min-width: 350px;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
            z-index: 10;
            gap: 2px;
        }

        .timer-videos-top, .timer-videos-bottom {
            display: flex;
            gap: 2px;
            width: 100%;
            height: 100px;
        }

        .timer-video-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        .timer-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .timer-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #timer {
            font-size: 3.5rem;
            font-weight: bold;
            text-align: center;
            font-variant-numeric: tabular-nums;
            color: #fff;
        }

        .label {
            font-size: 1rem;
            font-weight: normal;
            color: #888;
            display: block;
            margin-bottom: 10px;
        }

        #unmute-btn {
            padding: 10px 20px;
            background-color: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            margin-top: 15px;
        }

        #unmute-btn:hover {
            background-color: #333;
        }

        .hidden-media {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
    </style>
</head>
<body>

    <div class="left-videos" id="left-videos"></div>

    <div class="timer-section">
        <div class="timer-videos-top" id="timer-videos-top"></div>
        
        <div class="timer-content">
            <div id="timer">
                <span id="target-label" class="label">Checking schedule...</span>
                <span id="time-display">--:--</span>
            </div>
            <button id="unmute-btn">Pop out timer</button>
        </div>
        
        <div class="timer-videos-bottom" id="timer-videos-bottom"></div>
    </div>

    <div class="right-videos" id="right-videos"></div>

    <canvas id="pip-canvas" width="300" height="120" class="hidden-media"></canvas>
    <video id="pip-video" class="hidden-media" autoplay muted></video>

    <script>
        const displayElement = document.getElementById("time-display");
        const labelElement = document.getElementById("target-label");
        const canvas = document.getElementById("pip-canvas");
        const ctx = canvas.getContext("2d");
        const video = document.getElementById("pip-video");
        const leftVideos = document.getElementById("left-videos");
        const rightVideos = document.getElementById("right-videos");
        const timerVideosTop = document.getElementById("timer-videos-top");
        const timerVideosBottom = document.getElementById("timer-videos-bottom");
        const unmuteBtn = document.getElementById("unmute-btn");

        const stream = canvas.captureStream(1);
        video.srcObject = stream;

        const baseUrl = "https://github.com/howlonguntilhome/glowing-waffle/releases/download/videos/video-";
        const allVideos = [];

        function createVideoElement(index, startRandom = true) {
            const videoNum = String(index).padStart(5, '0');
            const videoUrl = `${baseUrl}${videoNum}.mp4`;
            
            const videoEl = document.createElement('video');
            videoEl.src = videoUrl;
            videoEl.loop = true;
            videoEl.muted = true;
            videoEl.playsInline = true;
            videoEl.autoplay = true;
            
            // Start at random timestamp
            if (startRandom) {
                videoEl.addEventListener('loadedmetadata', function() {
                    if (this.duration && isFinite(this.duration)) {
                        this.currentTime = Math.random() * this.duration;
                    }
                });
            }
            
            videoEl.play().catch(err => console.log('Autoplay prevented:', err));
            
            allVideos.push(videoEl);
            
            return videoEl;
        }

        // Create left side (videos 1-10) - 2 columns of 5
        for (let row = 0; row < 5; row++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'video-row';
            
            for (let col = 0; col < 2; col++) {
                const container = document.createElement('div');
                container.className = 'video-container';
                const videoEl = createVideoElement(row * 2 + col + 1);
                container.appendChild(videoEl);
                rowDiv.appendChild(container);
            }
            
            leftVideos.appendChild(rowDiv);
        }

        // Create right side (videos 11-20) - 2 columns of 5
        for (let row = 0; row < 5; row++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'video-row';
            
            for (let col = 0; col < 2; col++) {
                const container = document.createElement('div');
                container.className = 'video-container';
                const videoEl = createVideoElement(row * 2 + col + 11);
                container.appendChild(videoEl);
                rowDiv.appendChild(container);
            }
            
            rightVideos.appendChild(rowDiv);
        }

        // Create timer top videos (3 random videos)
        for (let i = 0; i < 3; i++) {
            const randomVideoIndex = Math.floor(Math.random() * 20) + 1;
            const container = document.createElement('div');
            container.className = 'timer-video-container';
            const videoEl = createVideoElement(randomVideoIndex);
            container.appendChild(videoEl);
            timerVideosTop.appendChild(container);
        }

        // Create timer bottom videos (3 random videos)
        for (let i = 0; i < 3; i++) {
            const randomVideoIndex = Math.floor(Math.random() * 20) + 1;
            const container = document.createElement('div');
            container.className = 'timer-video-container';
            const videoEl = createVideoElement(randomVideoIndex);
            container.appendChild(videoEl);
            timerVideosBottom.appendChild(container);
        }

        // Unmute all videos button
        unmuteBtn.addEventListener('click', async () => {
            for (const vid of allVideos) {
                try {
                    vid.muted = false;
                    await vid.play();
                } catch (err) {
                    console.error('Failed to pop out timer:', err);
                }
            }
            unmuteBtn.textContent = 'Click to pop out timer';
            unmuteBtn.disabled = true;
        });

        function getTargetTime() {
            const now = new Date();
            const day = now.getDay();
            
            const setTime = (h, m) => {
                const d = new Date(now);
                d.setHours(h, m, 0, 0);
                return d;
            };

            if (day === 6 || day === 0) {
                const target = new Date(now);
                target.setDate(now.getDate() + (day === 6 ? 2 : 1));
                target.setHours(8, 45, 0, 0);
                return { time: target, label: "Until Monday 8:45 AM" };
            }

            const startSchool = setTime(8, 45);
            const endHour = (day === 2) ? 14 : 15;
            const endMinute = (day === 2) ? 45 : 20;
            const endSchool = setTime(endHour, endMinute);

            if (now < startSchool) {
                return { time: startSchool, label: "Until 8:45 AM" };
            } else if (now < endSchool) {
                return { 
                    time: endSchool, 
                    label: `Until ${endHour > 12 ? endHour - 12 : endHour}:${endMinute} PM` 
                };
            } else {
                const target = new Date(now);
                target.setDate(now.getDate() + 1); 
                target.setHours(8, 45, 0, 0);
                
                if (day === 5) {
                    target.setDate(now.getDate() + 3);
                    return { time: target, label: "Until Monday 8:45 AM" };
                }

                return { time: target, label: "Until Tomorrow 8:45 AM" };
            }
        }

        function updateCountdown() {
            const now = new Date();
            const targetObj = getTargetTime();
            const target = targetObj.time;
            
            labelElement.innerText = targetObj.label;

            const diff = target - now;
            let displayString = "0m 00s";

            if (diff > 0) {
                const totalMinutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                if (hours > 0) {
                     displayString = `${hours}h ${minutes}m`;
                } else {
                     displayString = `${minutes}m ${seconds < 10 ? '0' : ''}${seconds}s`;
                }
            }

            displayElement.innerText = displayString;
            document.title = displayString;
            drawToCanvas(displayString);
        }

        function drawToCanvas(text) {
            ctx.fillStyle = "#121212";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "#e0e0e0";
            ctx.font = "bold 60px sans-serif"; 
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        }

        setInterval(updateCountdown, 1000);
        updateCountdown();
    </script>

</body>
</html>
